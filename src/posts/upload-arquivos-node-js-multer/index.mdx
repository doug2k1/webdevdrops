---
title: 'Upload de Arquivos no Node.js com Multer'
date: '2020-05-17'
categories:
  - 'Node.js'
tags:
  - 'nodejs'
coverImage: '/upload-arquivos-node-js-multer/images/node-js-file-upload.jpg'
---

E a√≠, devs! Neste post vou mostrar um exemplo simples de upload de arquivos em **Node.js** com **[Express](https://expressjs.com/)**, utilizando o middleware **[Multer](https://github.com/expressjs/multer)**.

<PostImage
  src="/upload-arquivos-node-js-multer/images/node-js-file-upload.jpg"
  width="940"
  height="788"
  alt="Upload de arquivos no Node.js"
/>

## Upload de arquivos

Existem v√°rias raz√µes para que se tenha a funcionalidade de upload de arquivos em uma aplica√ß√£o web. Seja para upload da foto do usu√°rio, imagens para montar uma galeria, v√≠deos, fazer upload de um arquivo CSV ou Excel para processamento de dados em lote, etc.

## Exemplo: Upload de imagem

Neste exemplo vamos mostrar o upload de uma imagem, mas o processo √© o mesmo para qualquer tipo de arquivo.

Nossa pequena aplica√ß√£o vai ter duas rotas: uma p√°gina inicial que vai mostrar um formul√°rio com campo de upload de arquivo, e uma rota `/avatar` que vai receber via `POST` a imagem, que vamos guardar e depois exibir de volta pro usu√°rio.

Vamos usar o framework **Express**, e **EJS** como template engine para montar o HTML das p√°ginas.

Nosso server inicial (server.js):

```javascript
const express = require('express')

const app = express()
app.set('view engine', 'ejs')
app.set('views', './src/views')

app.get('/', function (req, res) {
  res.render('index')
})

app.listen(3333, () => {
  console.log('üöÄ Server started on http://localhost:3333')
})
```

E nossa view (index.ejs) com o formul√°rio:

```markup
<form method="post" action="/avatar" enctype="multipart/form-data">
  <input type="file" name="avatar" accept="image/*">
  <button type="submit">Upload</button>
</form>
```

‚ö†Ô∏è Importante que o `form` tenha o atributo `enctype="multipart/form-data"`, para que o upload seja enviado corretamente.

### Rota de upload

A rota `/avatar`, que vai receber o upload via`post`, vai ficar assim:

```javascript
const multer = require('multer')
const upload = multer({ dest: 'uploads/' })

app.post('/avatar', upload.single('avatar'), function (req, res) {
  const { filename, size } = req.file

  return res.render('avatar', { image: `/uploads/${filename}`, size })
})
```

O **Multer** √© um middleware que vai interceptar o upload e salvar o arquivo em uma pasta do disco.

Para um upload b√°sico, a gente s√≥ precisa informar o destino onde os arquivos ser√£o salvos: `{ dest: 'uploads/' }`.

No tratamento da rota estamos dizendo que vamos receber apenas um arquivo, cujo `name` do campo no formul√°rio √© "avatar": `upload.single("avatar")`

O **Multer** tamb√©m permite upload de m√∫ltiplos arquivos, com `upload.array`.

Com isso o **Multer** disponibiliza na nossa requisi√ß√£o o valor `file`, que cont√©m os dados do arquivo salvo, como nome, localiza√ß√£o e tamanho.

### Exibindo a imagem de volta

Veja que na rota a gente renderiza uma view "avatar" passando o caminho do arquivo salvo, `/uploads/${filename}`, que podemos usar em uma tag image: `<img src="<%= image %>">`

Por√©m, precisamos configurar o Express para servir esta rota `/uploads` como arquivos est√°ticos:

```javascript
app.use('/uploads', express.static('uploads'))
```

### Renomeando arquivos

Um problema que temos aqui √© que o arquivo √© salvo com o nome original. Se dois usu√°rios enviarem imagens com o mesmo nome, um vai sobrescrever o arquivo do outro.

Podemos resolver isso configurando o **Multer** com uma fun√ß√£o para renomear os arquivos, gerando um nome √∫nico para cada um.

```javascript
const { uuid } = require('uuidv4')

const upload = multer({
  storage: multer.diskStorage({
    destination: 'uploads/',
    filename(req, file, callback) {
      const fileName = `${uuid()}-${file.originalname}`

      return callback(null, fileName)
    },
  }),
})
```

Usamos a lib **[uuidv4](https://www.npmjs.com/package/uuidv4)** para gerar um identificador √∫nico, que adicionamos no in√≠cio do nome original do arquivo.

### Alterando o local de salvamento

At√© aqui os arquivos est√£o sendo salvos em uma pasta com o mesmo nome da rota de acesso aos arquivos: `/uploads`, mas podemos salvar em qualquer local, sem precisar alterar a rota p√∫blica.

Para isso basta alterar o `destination` na configura√ß√£o do **Multer** e o mapeamento da rota `/uploads`:

```javascript
const uploadFolder = path.resolve(__dirname, '../../tmp')

const upload = multer({
  storage: multer.diskStorage({
    destination: uploadFolder,
  }),
})

app.use('/uploads', express.static(uploadFolder))
```

Desta forma podemos alterar a localiza√ß√£o dos arquivos no disco sem quebrar as URLs da aplica√ß√£o.

## Outros armazenamentos

O **Multer** possui outras formas de armazenamento, al√©m do `diskStorage`, que salva os arquivos no disco.

O `memoryStorage` guarda o arquivo na mem√≥ria, de forma que voc√™ pode manipular o arquivo sem precisar salvar. S√≥ tome cuidado com arquivos muito grandes, pra n√£o estourar a mem√≥ria do servidor.

Al√©m dos storages que o **Multer** oferece, existem op√ß√µes de terceiros como o **[Multer S3](https://github.com/badunk/multer-s3)**, que salva arquivos no servi√ßo **[Amazon S3](https://aws.amazon.com/pt/s3)**, e **[multer-cloud-storage](https://www.npmjs.com/package/multer-cloud-storage)**, que salva no **[Google Cloud](https://cloud.google.com/)**.

√â poss√≠vel tamb√©m desenvolver storages customizados. Veja mais detalhes sobre isso em: [https://github.com/expressjs/multer/blob/master/StorageEngine.md](https://github.com/expressjs/multer/blob/master/StorageEngine.md)

## Conclus√£o

O c√≥digo completo deste exemplo est√° aqui: [https://github.com/doug2k1/node-file-upload](https://github.com/doug2k1/node-file-upload)

Veja como ficou:

D√∫vidas, sugest√µes? Comente a√≠ embaixo!
