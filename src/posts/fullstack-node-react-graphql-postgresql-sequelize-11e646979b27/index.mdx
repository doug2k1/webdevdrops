---
title: 'Fullstack com Node.js, React e GraphQL‚Ää - 3: PostgreSQL e Sequelize'
date: '2018-03-16'
categories:
  - 'Full Stack'
tags:
  - 'full-stack'
  - 'graphql'
  - 'nodejs'
  - 'react'
coverImage: '/fullstack-node-react-graphql-postgresql-sequelize-11e646979b27/images/fullstack-3-1.png'
---

Ol√°, pessoal! Neste terceiro post da s√©rie [**Fullstack com Node.js, React e GraphQL**](/fullstack-node-react-graphql-introducao-2c2f18c757c4) vamos adicionar o banco de dados [**PostgreSQL**](https://www.postgresql.org/), fazendo o mapeamento entre o banco e a aplica√ß√£o com [**Sequelize**](http://docs.sequelizejs.com/).

<PostImage
  src="/fullstack-node-react-graphql-postgresql-sequelize-11e646979b27/images/fullstack-3-1-1024x558.png"
  width="1024"
  height="558"
  alt=""
/>

## Esquema do¬†banco

Nosso banco de dados vai come√ßar simples:

<PostImage
  src="/fullstack-node-react-graphql-postgresql-sequelize-11e646979b27/images/fullstack-3-2.png"
  width="878"
  height="328"
  alt=""
/>

Esquema do¬†banco

Temos a representa√ß√£o da **Corretora** (_Broker_). Cada corretora possui N **Investimentos** (_Investments_), e cada investimento pode possuir N **Transa√ß√µes** (_Transactions_), que s√£o dep√≥sitos e retiradas feitas naquele investimento, e N **Atualiza√ß√µes de Saldo** (_Balance Updates_), que s√£o mudan√ßas no saldo do investimento decorrentes do rendimento daquela aplica√ß√£o.

## PostgreSQL

Vamos guardar estes dados em um banco **PostgreSQL**, pelos motivos:

- √â gratuito e bem difundido, com bastante documenta√ß√£o dispon√≠vel.
- √â um dos bancos suportados pelo **Sequelize**, que era outra ferramenta que queria usar para aprendizado.
- O [**Heroku**](https://www.heroku.com/), servi√ßo onde vamos colocar a aplica√ß√£o em produ√ß√£o, oferece uma inst√¢ncia de PostgreSQL gratuita.

### Instala√ß√£o local

Em produ√ß√£o vamos usar o banco fornecido pelo Heroku, mas para desenvolvimento vamos precisar ter um banco local.

No [site oficial do PostgreSQL](https://www.postgresql.org/) tem op√ß√µes de download para seu sistema operacional e instru√ß√µes de instala√ß√£o. No MacOS eu uso e recomendo o [Postgres.app](http://postgresapp.com/), uma interface simples para instalar e executar o Postgres.

Se voc√™ curte [Docker](https://www.docker.com/), uma op√ß√£o √© usar um container com a [imagem do Postgres](https://store.docker.com/images/postgres). N√£o vou entrar em detalhes aqui para o post n√£o ficar longo.

### Cria√ß√£o do usu√°rio no¬†banco

Antes de come√ßar a criar a tabelas, precisamos criar um usu√°rio espec√≠fico para a nossa aplica√ß√£o dentro do Postgres.

> Evite usar o usu√°rio padr√£o, chamado _postgres_, em suas aplica√ß√µes, por motivo de seguran√ßa, pois ele tem todas as permiss√µes no banco inteiro, podendo alterar e apagar tudo.

Vamos usar o comando `psql` para acessar o banco.

Uma vez conectado, voc√™ vai estar em uma outra linha de comando, onde pode usar comandos espec√≠ficos no Postgres. um deles √© o `du`, que lista os usu√°rios existentes no banco:

<PostImage
  src="/fullstack-node-react-graphql-postgresql-sequelize-11e646979b27/images/fullstack-3-3-1024x221.png"
  width="1024"
  height="221"
  alt=""
/>

Vamos criar o usu√°rio _mymoney_ para a aplica√ß√£o (pode escolher uma senha mais segura üòâ):

```sql
CREATE ROLE mymoney WITH LOGIN PASSWORD '123456';
```

E dar permiss√£o para ele criar bancos de dados:

```sql
ALTER ROLE mymoney CREATEDB;
```

Se executar um `du` novamente, vai ver o novo usu√°rio criado. Voc√™ pode usar `q` para sair do _psql_.

## Sequelize

[**Sequelize**](http://docs.sequelizejs.com/) √© um ORM (_Object-Relational Mapper_) para Node.js. Eles faz o mapeamento de dados relacionais (armazenados tabelas, linhas e colunas) para objetos em JS. Ele permite **criar**, **buscar**, **alterar** e **remover** dados do banco usando objetos e m√©todos em JS, al√©m de fazer altera√ß√µes na estrutura das tabelas. Ele suporta os bancos PostgreSQL, MySQL, MSSQL e SQLite.

### Instala√ß√£o

Vamos instalar o Sequelize e o m√≥dulo **pg**, para trabalhar com Postgres:

npm i sequelize pg

Vamos instalar tamb√©m a ferramenta de linha de comando do Sequelize (CLI) como depend√™ncia de desenvolvimento:

npm i -D sequelize-cli

### Inicializa√ß√£o

Vamos usar o **sequelize-cli** para gerar alguns arquivos iniciais, mas antes vamos configurar onde ele vai criar esses arquivos. Vamos criar um arquivo¬†*.sequelizerc* na raiz, com o conte√∫do:

```javascript
const path = require('path')

module.exports = {
  config: path.resolve('config/database.js'),
  'migrations-path': path.resolve('db/migrate'),
  'seeders-path': path.resolve('db/seeds'),
  'models-path': path.resolve('src/models'),
}
```

J√° j√° explico o que s√£o esses arquivos. Agora vamos rodar no terminal:

npx sequelize init

Este comando vai criar os arquivos iniciais do Sequelize.

> **npx** √© um comando que j√° vem com o NPM a partir da vers√£o 5.2.0. Ele roda um execut√°vel que foi instalado via NPM, sem precisar passar o caminho do execut√°vel nem instal√°-lo globalmente. No exemplo acima ele vai executar o sequelize que est√° nas nossas depend√™ncias (pasta node_modules).  
> Mais detalhes: [https://medium.com/@maybekatz/introducing-npx-an-npm-package-runner-55f7d4bd282b](https://medium.com/@maybekatz/introducing-npx-an-npm-package-runner-55f7d4bd282b)

### Configura√ß√£o

O arquivo _config/database.js_ cont√©m as informa√ß√µes de conex√£o ao banco, separadas em 3 ambientes: desenvolvimento, testes e produ√ß√£o. Vamos configurar apenas o ambiente de desenvolvimento por enquanto:

```javascript
development: {
  username: 'mymoney',
  password: '123456',
  database: 'mymoney',
  host: '127.0.0.1',
  dialect: 'postgres'
},
```

E essa senha escancarada a√≠? N√£o podemos comitar isso.

Vamos criar um arquivo de senhas e outras configura√ß√µes sigilosas, _config/secret.js_:

```javascript
module.exports = {
  DATABASE_PASSWORD: '123456',
}
```

Adicionar `config/secret.js` no¬†*.gitignore* e us√°-lo nas configura√ß√µes do banco:

```javascript
const secret = require('./secret');

module.exports = {
  development: {
    username: 'mymoney',
    password: secret.DATABASE_PASSWORD,
    database: 'mymoney',
    host: '127.0.0.1',
    dialect: 'postgres'
  },
  test: ...,
  production: ...
};
```

Se o ESLint reclamar que voc√™ est√° usando um arquivo ignorado, adicione no seu¬†.eslintrc:

```javascript
rules: {
  'node/no-unpublished-require': 'off'
}
```

## Cria√ß√£o do¬†banco

Para criar o banco, executamos o comando:

npx sequelize db:create

## Modelos

Vamos criar nosso primeiro modelo: **Broker** (Corretora). Basta executar:

npx sequelize model:generate --name Broker --attributes name:string

Este comando vai criar dois arquivos: **_src/models/broker.js_** e **_db/migrate/20180311115229-create-broker.js_**

O primeiro √© o **modelo** em si, que detalha os atributos do objeto **Broker**, seus tipos, regras de valida√ß√£o e relacionamento com outros modelos.

O segundo √© o **arquivo de migra√ß√£o**, que descreve como esta altera√ß√£o deve ser feita no banco de dados (no caso, ser√° feita a cria√ß√£o de uma nova tabela).

> **Migrac√£o (ou migration)** √© o processo alterar a estrutura de um banco de dados (criar/remover tabelas, colunas, alterar tipos e relacionamentos) de forma incremental e reversiva, e minimizando o impacto nos dados existentes.

Vamos fazer algumas altera√ß√µes manuais nestes arquivos. No modelo, vamos adiciona uma valida√ß√£o no campo `name` para que ele seja obrigat√≥rio:

```javascript
name: { type: DataTypes.STRING, allowNull: false }
```

Vamos fazer a mesma coisa no arquivo de migra√ß√£o, mas desta vez para adicionar a valida√ß√£o a n√≠vel do banco de dados:

```javascript
name: {
  allowNull: false,
  type: Sequelize.STRING
},
```

### Segundo modelo e relacionamento

O pr√≥ximo modelo, **Investment** (Investimento), tem uma peculiaridade. Ele tem uma rela√ß√£o com o **Broker** (Corretora), j√° que **_uma Corretora possui muitos Investimentos_** e **_um Investimento pertence a uma Corretora_**.

Primeiro, a gera√ß√£o dos arquivos de modelo e migra√ß√£o:

npx sequelize model:generate --name Investment --attributes name:string

Assim como no **Broker**, vamos adicionar a valida√ß√£o de obrigatoriedade no campo _name_, e tamb√©m vamos especificar os relacionamentos.

No modelo de Investimento, dizemos que ele **pertence a** (_belongs to_) Corretora:

```javascript
Investment.associate = function (models) {
  this.belongsTo(models.Broker)
}
```

E no arquivo de migra√ß√£o de Investimento adicionamos o campo _BrokerId_, que faz a liga√ß√£o com a tabela de Corretora (chave estrangeira):

```javascript
BrokerId: {
   allowNull: false,
   type: Sequelize.INTEGER,
   onDelete: 'CASCADE',
   references: {
     model: 'Brokers',
     key: 'id'
   }
 },
```

Por fim, no modelo de Corretora dizemos que ele **possui muitos** (_has many_) Investimentos:

```javascript
Broker.associate = function (models) {
  this.hasMany(models.Investment)
}
```

### Outros modelos

Para finalizar, a cria√ß√£o dos outros modelos e migra√ß√µes:

npx sequelize model:generate --name Transaction --attributes amount:decimal,date:dateonly
npx sequelize model:generate --name BalanceUpdate --attributes amount:decimal,date:dateonly

Lembrando de adicionar as rela√ß√µes: **Investimento possui muitas Transa√ß√µes** e **Investimento possui muitas Atualiza√ß√µes de Saldo**.

Nos modelos e migra√ß√µes, al√©m das valida√ß√µes de obrigatoriedade, tamb√©m adicionei precis√£o nos campos de valores:

```javascript
amount: { type: DataTypes.DECIMAL(16, 2), allowNull: false }
```

Voc√™ pode ver aqui o resultado final dos modelos:¬†  
[https://github.com/doug2k1/my-money/tree/v2.0.0/src/models](https://github.com/doug2k1/my-money/tree/v2.0.0/src/models)  
e migra√ß√µes:  
[https://github.com/doug2k1/my-money/tree/v2.0.0/db/migrate](https://github.com/doug2k1/my-money/tree/v2.0.0/db/migrate)

## Executando as migra√ß√µes

Ok, os modelos est√£o descritos no nosso c√≥digo, mas ainda precisamos fazer as altera√ß√µes no banco:

npx sequelize db:migrate

Para conferir que as tabelas foram criadas, podemos acessar o **psql** com o usu√°rio _mymoney_, listar as tabelas com `dt` e ver as informa√ß√µes de cada tabela com `d+ "NomeDaTabela"`:

```bash
psql -U mymoney

mymoney=> \dt

mymoney=> \d+ "Brokers"
```

## Testando tudo

Para testar nosso banco e modelos, podemos adicionar o seguinte c√≥digo no nosso server (_src/index.js_):

```javascript
const { Broker, Investment, Transaction, BalanceUpdate } = require('./models')

const test = async () => {
  // create broker
  const broker = await Broker.create({ name: 'Fooinvest' })
  // create investment
  const investment = await Investment.create({
    name: 'Tesouro Foo',
    BrokerId: broker.get('id'),
  })
  // create transaction
  await Transaction.create({
    amount: 500,
    date: '2018-03-10',
    InvestmentId: investment.get('id'),
  })
  // create balance update
  await BalanceUpdate.create({
    amount: 501,
    date: '2018-03-12',
    InvestmentId: investment.get('id'),
  })
  // select all
  const brokerWithDetails = await Broker.findOne({
    include: [
      {
        model: Investment,
        include: [{ model: Transaction }, { model: BalanceUpdate }],
      },
    ],
  })
  console.log(JSON.stringify(brokerWithDetails))
}

test()
```

Ele importa os modelos e usa as fun√ß√µes do Sequelize para criar entidades (ex: `Broker.create`) e buscar no banco (ex: `Broker.findOne`).

Mais detalhes da API de model do Sequelize e todas as fun√ß√µes dispon√≠veis para cria√ß√£o de busca de dados: [http://docs.sequelizejs.com/manual/tutorial/models-usage.html](http://docs.sequelizejs.com/manual/tutorial/models-usage.html)

Vamos explorar mais estes modelos nas pr√≥ximas partes.

## Resultado final

O c√≥digo do projeto at√© este ponto est√° em: [https://github.com/doug2k1/my-money/tree/v2.0.0](https://github.com/doug2k1/my-money/tree/v2.0.0)

## No pr√≥ximo¬†cap√≠tulo

Na pr√≥xima parte vamos criar a interface administrativa usando [**Forest Admin**](https://www.forestadmin.com/). _Stay tuned!_

## Feedbacks?

E a√≠, o que est√° achando at√© agora? Algo que precisa melhorar?
